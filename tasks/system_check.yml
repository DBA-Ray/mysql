# 系统环境检测，排除干扰

- name: 关闭firewalld
  service: name=firewalld state=stopped enabled=no

- name: 永久关闭selinux
  lineinfile:
    dest: /etc/selinux/config
    regexp: "^SELINUX="
    line: "SELINUX=disabled"

- name: 卸载系统自带的mariadb
  yum:
    name: mariadb
    state: absent

- name: Disable kernel hugepage
  shell: "echo never > /sys/kernel/mm/transparent_hugepage/enabled;echo never > /sys/kernel/mm/transparent_hugepage/defrag"

- name: Disable swap
  sysctl:
    name: vm.swappiness
    value: '0'
    sysctl_file: /etc/sysctl.conf
    state: present
    reload: yes

- name: Disable file system atime
  mount:
    path: "{{ install_dir }}"
    src: "{{ fstab_src }}"
    fstype: ext4
    opts: defaults,noatime,nobarrier
    state: present
    backup: yes

- name: Remount file path
  mount:
    path: "{{ install_dir }}"
    src: "{{ fstab_src }}"
    fstype: ext4
    opts: defaults,noatime,nobarrier
    state: remounted

- name: Install the mysql repo
  yum:
    name: "{{ remote_repo }}"
    state: present
  register: repo
  retries: 7
  until: repo is succeeded

- name: Copy the mysql-community.repo
  copy: src=mysql-community.repo dest=/etc/yum.repos.d/mysql-community.repo

- name: Install base packages
  yum:
    name: "{{ packages }}"
    state: latest

- name: Stop mysql server
  systemd:
    name: mysqld
    state: stopped
  when: whether_uninstall

- name: Remove existing mysql directory
  file:
    path: "{{ datadir }}"
    state: absent
    remote_src: yes
  when: whether_uninstall

#- name: 更新所有软件包
#  yum:
#    name: '*'
#    state: latest